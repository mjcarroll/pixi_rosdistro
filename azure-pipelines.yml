# Azure Pipelines CI for ROS 2 Rolling Source Build
# Uses Pixi for dependency management across all platforms.

trigger:
  branches:
    include:
      - main
      - rolling

pr:
  branches:
    include:
      - main
      - rolling

variables:
  PIXI_VERSION: "latest"

stages:
  - stage: Build
    jobs:
      # ======================================================================
      # Linux (Ubuntu)
      # ======================================================================
      - job: Linux
        pool:
          vmImage: "ubuntu-latest"
        timeoutInMinutes: 360
        variables:
          CCACHE_DIR: $(Pipeline.Workspace)/.ccache
        steps:
          - checkout: self
            fetchDepth: 1

          # Cache the Pixi environment
          - task: Cache@2
            inputs:
              key: 'pixi | "linux-64" | pixi.lock'
              path: $(Build.SourcesDirectory)/.pixi
            displayName: "Cache Pixi environment"

          # Cache ccache directory
          - task: Cache@2
            inputs:
              key: 'ccache | "linux-64" | $(Build.BuildId)'
              restoreKeys: |
                ccache | "linux-64"
              path: $(CCACHE_DIR)
            displayName: "Cache ccache"

          # Install Pixi
          - script: |
              curl -fsSL https://pixi.sh/install.sh | bash
              echo "##vso[task.prependpath]$(HOME)/.pixi/bin"
            displayName: "Install Pixi"

          # Install dependencies
          - script: pixi install
            displayName: "Install dependencies"

          # Fetch ROS 2 sources
          - script: pixi run fetch
            displayName: "Fetch ROS 2 sources"

          # Build (up to rclcpp)
          - script: pixi run build
            displayName: "Build ROS 2 (up to rclcpp)"

      # ======================================================================
      # Windows
      # ======================================================================
      - job: Windows
        pool:
          vmImage: "windows-latest"
        timeoutInMinutes: 360
        variables:
          SCCACHE_DIR: $(Pipeline.Workspace)\.sccache
        steps:
          - checkout: self
            fetchDepth: 1

          # Cache the Pixi environment
          - task: Cache@2
            inputs:
              key: 'pixi | "win-64" | pixi.lock'
              path: $(Build.SourcesDirectory)\.pixi
            displayName: "Cache Pixi environment"

          # Cache sccache directory
          - task: Cache@2
            inputs:
              key: 'sccache | "win-64" | $(Build.BuildId)'
              restoreKeys: |
                sccache | "win-64"
              path: $(SCCACHE_DIR)
            displayName: "Cache sccache"

          # Install Pixi
          - powershell: |
              iwr -useb https://pixi.sh/install.ps1 | iex
              echo "##vso[task.prependpath]$env:USERPROFILE\.pixi\bin"
            displayName: "Install Pixi"

          # Install dependencies
          - script: pixi install
            displayName: "Install dependencies"

          # Fetch ROS 2 sources
          - script: pixi run fetch
            displayName: "Fetch ROS 2 sources"

          # Build (up to rclcpp)
          - script: pixi run build
            displayName: "Build ROS 2 (up to rclcpp)"

      # ======================================================================
      # macOS (Intel)
      # ======================================================================
      - job: macOS_x64
        pool:
          vmImage: "macos-13"
        timeoutInMinutes: 360
        variables:
          CCACHE_DIR: $(Pipeline.Workspace)/.ccache
        steps:
          - checkout: self
            fetchDepth: 1

          # Cache the Pixi environment
          - task: Cache@2
            inputs:
              key: 'pixi | "osx-64" | pixi.lock'
              path: $(Build.SourcesDirectory)/.pixi
            displayName: "Cache Pixi environment"

          # Cache ccache directory
          - task: Cache@2
            inputs:
              key: 'ccache | "osx-64" | $(Build.BuildId)'
              restoreKeys: |
                ccache | "osx-64"
              path: $(CCACHE_DIR)
            displayName: "Cache ccache"

          # Install Pixi
          - script: |
              curl -fsSL https://pixi.sh/install.sh | bash
              echo "##vso[task.prependpath]$(HOME)/.pixi/bin"
            displayName: "Install Pixi"

          # Install dependencies
          - script: pixi install
            displayName: "Install dependencies"

          # Fetch ROS 2 sources
          - script: pixi run fetch
            displayName: "Fetch ROS 2 sources"

          # Build (up to rclcpp)
          - script: pixi run build
            displayName: "Build ROS 2 (up to rclcpp)"

      # ======================================================================
      # macOS (Apple Silicon)
      # ======================================================================
      - job: macOS_arm64
        pool:
          vmImage: "macos-latest"
        timeoutInMinutes: 360
        variables:
          CCACHE_DIR: $(Pipeline.Workspace)/.ccache
        steps:
          - checkout: self
            fetchDepth: 1

          # Cache the Pixi environment
          - task: Cache@2
            inputs:
              key: 'pixi | "osx-arm64" | pixi.lock'
              path: $(Build.SourcesDirectory)/.pixi
            displayName: "Cache Pixi environment"

          # Cache ccache directory
          - task: Cache@2
            inputs:
              key: 'ccache | "osx-arm64" | $(Build.BuildId)'
              restoreKeys: |
                ccache | "osx-arm64"
              path: $(CCACHE_DIR)
            displayName: "Cache ccache"

          # Install Pixi
          - script: |
              curl -fsSL https://pixi.sh/install.sh | bash
              echo "##vso[task.prependpath]$(HOME)/.pixi/bin"
            displayName: "Install Pixi"

          # Install dependencies
          - script: pixi install
            displayName: "Install dependencies"

          # Fetch ROS 2 sources
          - script: pixi run fetch
            displayName: "Fetch ROS 2 sources"

          # Build (up to rclcpp)
          - script: pixi run build
            displayName: "Build ROS 2 (up to rclcpp)"
